# Comprehensive Architecture Intelligence Map: `regulatory-kb/library`

Generated on: 2026-02-17 (UTC)
Repository commit: `8669c98921409c65d2155f27214a9e4aa55790b3`
Primary scope root: `/Users/aran.berzingi/togetherai/regulatory-kb/library`
External coupled file: `/Users/aran.berzingi/togetherai/inference.ts`

---

## 1. Executive Summary (Non-Technical)

`regulatory-kb` is a markdown-first regulatory knowledge pipeline. Domain experts author source-of-truth content in `library/**`, and TypeScript scripts in `technical/scripts/**` validate and transform that content into machine artifacts under `technical/artifacts/**` and a published mirror under `public/artifacts/**`.

The architecture is coherent around that model, but the current state is partially incomplete:

- Domain taxonomy content is still largely placeholder (`24` of `42` `library/**` files are empty).
- The relation-graph build path references removed legacy paths and currently fails.
- Validation/test signals are mixed: tests pass, but key content validation commands fail.
- Critical logic is concentrated in a few large modules, creating high change risk.

For onboarding and refactor planning, this system should be viewed as a file-driven pipeline monolith with strong path-contract coupling and limited runtime abstraction boundaries.

---

## 2. Architectural Deep Dive

### 2.1 System Intent and Architecture Style

Inferred architecture:

- Primary style: Layered content-processing monolith (file-based ETL).
- Secondary style: CLI toolchain orchestrated by npm scripts + GitHub Actions.
- Not present: API server layer, database layer, message queue workers.

Execution center:

- Source markdown in `library/**`.
- Processing scripts in `technical/scripts/**`.
- Canonical outputs in `technical/artifacts/**`.
- Published copy in `public/artifacts/**`.
- External consumer coupling via `/Users/aran.berzingi/togetherai/inference.ts`.

### 2.2 Scope and Completeness Baseline

Inventory source: `technical/docs/architecture/library-system-intelligence-map.inventory.tsv`

Current analyzed totals:

- Total files: `123`
- Total bytes: `562,492`
- Total lines: `17,483`
- Empty files: `24` (all in `library/**`)

Scope split:

- `.github/**`: `2`
- `library/**`: `42`
- `technical/**`: `61`
- `public/artifacts/**`: `3`
- root configs (`package.json`, `tsconfig.json`, `README.md`, `AGENTS.md`): `4`
- external coupled file: `1`

File types:

- `md`: `61`
- `ts`: `42`
- `json`: `15`
- `yml`: `2`
- `cypher`: `1`
- `adjlist`: `1`
- `tsv`: `1`

### 2.3 Directory Mapping, Purpose, and Coupling Patterns

| Directory | Purpose | Architectural Role | Coupling Pattern |
|---|---|---|---|
| `library/ontologies/` | Regulatory ontology definitions in markdown | Domain contract layer | Parsed by validators/generators (`validate_ontology`, `sync_schemas`, `build_json`) |
| `library/ontologies/.../examples/` | Example enforcement records | Domain sample layer | Consumed by validation + inference model generation |
| `library/taxonomy/AML/_templates/` | Authoring templates for taxonomy docs | Domain authoring support | Used by scaffold workflows/operator conventions |
| `library/taxonomy/AML/concepts/` | Concept and subconcept semantic nodes | Domain semantics layer | Required by `inference_mapping` and `scaffold_catalog` |
| `library/taxonomy/AML/map/` | Jurisdiction/law/provision mapping hierarchy | Domain mapping layer | Required by `inference_mapping` and taxonomy sync/validation |
| `library/taxonomy/generated/` | Generated relation tuples + cypher | Generated integration layer | Written by generators; consumed externally by `inference.ts` |
| `library/taxonomy/index_*.md` | Taxonomy index contracts | Domain index layer | Read/written by `sync_taxonomy` and scaffold index helpers |
| `technical/scripts/` | Build/validate/generate/publish entrypoints | Service orchestration layer | Tight coupling to path conventions and shared libs |
| `technical/scripts/lib/` | Shared parsing, IO, catalog, validation helpers | Utility/infrastructure layer | Core dependency hubs (`io.ts`, `structured_markdown.ts`, `inference_mapping.ts`) |
| `technical/scripts/lib/scaffold/` | Scaffolding subsystem | Adapter/workflow layer | Dense internal coupling among prompts/handlers/indexes |
| `technical/scripts/tests/` | Node test suites and fixture helpers | Quality layer | Strong coverage of parser/scaffold libs; weaker entrypoint coverage |
| `technical/schemas/` | Static JSON schema references | Contract/reference layer | Partially stale relative to active output set |
| `technical/artifacts/` | Canonical generated machine artifacts | Data output layer | Generated by scripts; mirrored to public |
| `public/artifacts/` | Site-served artifact mirror | Publication layer | Overwritten by publish script |
| `.github/workflows/` | CI validation and build automation | Infrastructure orchestration | Runs npm script chains |

### 2.4 Entry Points, Shared Abstractions, Config, and Glue

Entry points:

- Script files: `technical/scripts/*.ts`
- NPM scripts: `package.json#scripts`
- CI workflows: `.github/workflows/validate.yml`, `.github/workflows/deploy-docs.yml`

Shared abstractions:

- `technical/scripts/lib/io.ts`: path normalization, check mode, stable writes.
- `technical/scripts/lib/structured_markdown.ts`: markdown section grammar/parsing.
- `technical/scripts/lib/inference_mapping.ts`: taxonomy inference model build/validation.

Configuration layers:

- `package.json`, `tsconfig.json`, `.nvmrc`, `README.md`, `AGENTS.md`
- `technical/schemas/**`
- Markdown metadata contracts under `library/**`

Infrastructure glue:

- chained npm scripts (`kb:build-all`, `kb:check`)
- artifact publish mirror (`publish_artifacts.ts`)
- tracked path inventory (`path_inventory.ts` + `git ls-files`)

### 2.5 Layering Quality (Clean vs Leaky)

Layer diagram:

```text
+---------------------------------------------------------+
| CI/Automation                                           |
| .github/workflows/* -> npm scripts                     |
+----------------------+----------------------------------+
                       |
+----------------------v----------------------------------+
| Entrypoint Scripts (technical/scripts/*.ts)            |
+----------------------+----------------------------------+
                       |
+----------------------v----------------------------------+
| Shared Processing Libs (technical/scripts/lib/**)       |
+----------------------+----------------------------------+
                       |
+----------------------v----------------------------------+
| Domain Content (library/**)                             |
+----------------------+----------------------------------+
                       |
+----------------------v----------------------------------+
| Generated Artifacts                                     |
| technical/artifacts/** -> public/artifacts/**          |
+----------------------+----------------------------------+
                       |
+----------------------v----------------------------------+
| External consumer coupling                              |
| /Users/.../inference.ts                                |
+---------------------------------------------------------+
```

Layer cleanliness verdict:

- Mostly clean domain/technical split.
- Leaks exist where scripts hardcode exact path structures and parent-directory assumptions.
- Legacy references remain in active scripts/docs (`library/relations/**` expectations).

---

## 3. Module-by-Module Breakdown

### 3.1 Domain Modules (`library/**`)

#### A) Ontology and Example Modules

| Module | Responsibility | Public Contract | Side Effects | Cross-Module Relationship |
|---|---|---|---|---|
| `library/ontologies/document-types/enforcement-actions/jurisdictions/se/enforcement-actions.md` | Canonical Sweden enforcement ontology | `metadata`, `fields`, `affected_regulations_item`, `validation_rules` sections | None | Read by `validate_ontology.ts`, `sync_schemas.ts`, `build_json.ts` |
| `library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/se-example-001.md` | Reference record example | `record`, `affected_regulations`, `statutory_references` | None | Used by validation and inference mapping |
| `library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/enforcement-action-Svea-Bank.md` | Additional structured example | Same contract sections | None | Used by validation and mapping |
| `library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/Svea.md` | Example with richer sections | Currently missing required `affected_regulations` | None | Contributes to `kb:check` failure |
| `library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/Svea_bank.md` | Alternate Svea variant | Currently missing required `affected_regulations` | None | Contributes to `kb:check` failure |
| `library/ontologies/document-types/legislation/law.md` | Generic law ontology | Metadata + fields + validation rules | None | Reference/contractual module |
| `library/ontologies/document-types/legislation/jurisdictions/EU/law.json` | EU law ontology | EU reference/address contract | None | Reference model for EU provisions |
| `library/ontologies/document-types/legislation/jurisdictions/Sweden/law.json` | Swedish law ontology | canonical `SE,RD,2017:630,...` addressing contract | None | Basis for mapping address validation |

#### B) Taxonomy Index/Template Modules

| Module | Responsibility | Contract | Side Effects | Coupling |
|---|---|---|---|---|
| `library/taxonomy/index_concepts.md` | Concept registry | `Concept` + nested `Subconcept` entries | Mutated by sync/scaffold | Parsed/written by scaffold + taxonomy sync |
| `library/taxonomy/index_jurisdiction.md` | Jurisdiction/law/provision registry | `Jurisdiction` -> `Law` -> `Level_*` hierarchy links | Mutated by sync/scaffold | Parsed by sync/scaffold/catalog |
| `library/taxonomy/index_enforcement_actions.md` | Enforcement action index | list entries with links | Mutated by sync/scaffold | Parsed/written by scaffold indexes |
| `library/taxonomy/AML/_templates/concept_template.md` | Concept authoring skeleton | metadata/references/subconcept sections | None | Operator/scaffold reference |
| `library/taxonomy/AML/_templates/provision_template.md` | Provision authoring skeleton | metadata/topics sections | None | Operator/scaffold reference |
| `library/taxonomy/AML/_templates/enforcement_action_template.md` | Enforcement action authoring skeleton | record/concepts/statutory sections | None | Operator/scaffold reference |

#### C) Taxonomy Corpus + Generated Modules

| Module Group | Responsibility | Current State | Coupling |
|---|---|---|---|
| `library/taxonomy/AML/concepts/**/*.md` | Concept semantic sources | `2` files, one non-empty root concept, one empty subconcept | Read by `inference_mapping.ts`; empty file causes validation failure |
| `library/taxonomy/AML/map/**/legislation/**/*.md` | Provision mapping hierarchy | Largely empty placeholders, one populated Sweden level-4 provision leaf | Read by inference model and taxonomy sync |
| `library/taxonomy/generated/relations.generated.ts` | Generated tuple module | Non-empty generated source with exported relation arrays | Imported by external `/Users/.../inference.ts` |
| `library/taxonomy/generated/inference.cypher` | Generated cypher merge script | Non-empty generated output | Produced by `generate_cypher.ts` |

### 3.2 Entrypoint Script Modules (`technical/scripts/*.ts`)

| Module | Purpose | Public Interface | Outputs/Returns | Side Effects |
|---|---|---|---|---|
| `build_json.ts` | Build ontology JSON artifact and prune removed scopes | CLI `main()` | Writes ontology artifact JSON | Remove/write operations in `technical/artifacts/**` |
| `build_relation_graph.ts` | Build relation graph artifact from relation mappings + ontology relations | CLI `main()` | Intended `technical/artifacts/relations/graph.json` | Fails currently due missing `library/relations/**` |
| `generate_compass.ts` | Generate compact repository compass index | CLI `main()` | `technical/docs/compass/index.md` | Writes markdown |
| `generate_cypher.ts` | Emit deterministic cypher from inference model | CLI `main()` | `library/taxonomy/generated/inference.cypher` | Writes generated file |
| `generate_inference_relations.ts` | Emit deterministic TS relation tuples | CLI `main()` | `library/taxonomy/generated/relations.generated.ts` | Writes generated file |
| `generate_manifest.ts` | Build artifact manifest metadata | CLI `main()` | `technical/artifacts/manifest.json` | Reads stats; writes manifest |
| `generate_paths.ts` | Generate full path inventory for docs | CLI `main()` | `technical/docs/compass/paths.md` | Writes markdown |
| `publish_artifacts.ts` | Mirror canonical artifacts to public folder | CLI `main()` | Copy completion log | Deletes/replaces `public/artifacts/**` |
| `scaffold.ts` | Scaffold CLI bootstrap | wrapper call to `runScaffoldCli` | none | Delegates to write-capable scaffold handlers |
| `sync_schemas.ts` | Build schema JSON from ontology markdown | CLI `main()` | `technical/artifacts/schemas/enforcement-actions/se.schema.json` | Prunes/writes schema files |
| `sync_taxonomy.ts` | Validate and reconcile taxonomy index and path drift | CLI `main()` | check/pass or drift report | Can create/remove/update taxonomy files |
| `validate_ontology.ts` | Validate ontology and example markdown contract | CLI `main()` | pass/fail report | Read-only validation with non-zero exit on errors |
| `validate_taxonomy_mappings.ts` | Validate inference mapping model consistency | CLI `main()` | pass/fail summary | Read-only validation |
| `verify_inference_equivalence.ts` | Compare generated mapping against external hardcoded inference | CLI `main()` | pass/fail diff report | Reads external `/Users/.../inference.ts` |

### 3.3 Shared Library Modules (`technical/scripts/lib/*.ts`)

| Module | Core Responsibility | Exposed API (selected) | Internal Logic Highlights | Coupling / Reuse Assessment |
|---|---|---|---|---|
| `io.ts` | Shared path/write/check utilities | `getRunOptions`, `repoPath`, `writeJsonFile`, `writeTextFile`, `listJsonFiles` | stable compare-before-write, check mode short-circuit | Reusable and central hub; highest in-degree (`18`) |
| `structured_markdown.ts` | Parse markdown contracts | `extractMarkdownSections`, `parseKeyValueBullets`, `readStructuredMarkdownDoc`, `globMarkdown` | strict bullet grammar, legacy JSON fallback, section normalization | Reusable parser core; second-highest in-degree (`6`) |
| `inference_mapping.ts` | Build normalized inference model | `parseConceptReferencesSection`, `loadInferenceMappingModel` | canonical SE/EU address parsing, hierarchy checks, pair-diff consistency checks | High-value but overloaded monolith (`~1991 LOC`) |
| `schema.ts` | Convert normalized field defs to JSON schema | `fieldToJsonSchema`, `enumSetFromField` | field type mapping + enum extraction helpers | Small utility; straightforward |
| `path_inventory.ts` | Compute tracked file/dir inventory via git | `listRepositoryFiles`, `getPathInventory` | `git ls-files` + untracked enumeration | Infra helper with external command dependency |
| `scaffold_catalog.ts` | Build selectable catalog for scaffold flows | `loadScaffoldCatalog`, lookup + number helpers | merges index files, filesystem, inferred law code candidates | Medium complexity and high coupling to content grammar |
| `cli_prompts.ts` | Prompt abstraction + back-navigation primitives | `PromptAdapter`, `interactivePromptAdapter`, validated/select helpers | sentinel-driven back handling and input normalization | Adapter module; decouples UI provider from flow logic |

### 3.4 Scaffold Submodules (`technical/scripts/lib/scaffold/*.ts`)

| Module | Responsibility | Public Interface | Side Effects | Coupling Notes |
|---|---|---|---|---|
| `scaffold/cli.ts` | CLI parsing + command routing | `parseCliOptionMap`, `runScaffoldCli` | Indirect writes via handlers | Orchestrator for scaffold subsystem |
| `scaffold/handlers.ts` | Create/update concept/provision/enforcement files and indexes | `scaffoldConcept`, `scaffoldProvision`, `validateConceptIdsExist`, `scaffoldEnforcementAction`, `scaffoldEnforcementActionFromCliOptions` | direct file writes/updates | Highest out-degree (`8`); overloaded |
| `scaffold/prompts.ts` | Domain prompt flows for law/ref/concept selection | prompt helper exports (`promptLawCode*`, `promptSwedishAddress*`, etc.) | no direct FS writes | Complex state flow; high branching |
| `scaffold/indexes.ts` | Parse and write index markdown | read/write index exports | writes index files | Tight to markdown format conventions |
| `scaffold/references.ts` | Canonical reference parsing/formatting/validation | reference utility exports | none | Pure helper; reusable |
| `scaffold/provision_files.ts` | Ensure hierarchical provision files | `ensureProvisionFile`, level helpers | creates dirs/files, writes content | FS-mutation utility |
| `scaffold/paths.ts` | Canonical path builders | path helper exports | none | Shared low-risk helper |
| `scaffold/types.ts` | Shared scaffold data types/constants | interfaces + `DECISION_TYPES` | none | Type contract module |

### 3.5 Testing and Quality Modules (`technical/scripts/tests/*.ts`)

| Test Module | Main Focus | Unit/Integration Bias | Mocking Pattern |
|---|---|---|---|
| `cli_prompts.test.ts` | prompt adapter behavior and validation wrappers | unit | mock adapter queue |
| `inference_mapping.test.ts` | concept/provision reference parsing and generator integration | mixed | temp cwd + fixture files + child process |
| `scaffold.test.ts` | scaffold CLI outcomes | integration-style | child process + fixture workspace |
| `scaffold_catalog.test.ts` | catalog building from index/fs inputs | unit | temp fixture trees |
| `scaffold_cli.test.ts` | CLI argument parsing | unit | pure function tests |
| `scaffold_handlers_back.test.ts` | back-navigation across scaffold handlers | integration-style | mock prompt adapter + temp fixtures |
| `scaffold_indexes.test.ts` | index parse/write compatibility | unit | temp fixtures |
| `scaffold_prompts_back.test.ts` | back-navigation in prompt helpers | unit | mock prompt adapter |
| `scaffold_references.test.ts` | reference normalization helpers | unit | pure functions |
| `structured_markdown.test.ts` | markdown parsing and strict-format validation | unit | temp fixtures |
| `test_fs.ts` | fixture/cwd utilities used by tests | utility | helper module |

Direct runtime coverage gap:

- runtime modules: `29`
- directly exercised via imports in tests: `10`
- directly untested runtime modules: `20` (Appendix F)

### 3.6 Config, Workflow, Schema, Artifact, and External Modules

| Module Group | Responsibility | Notes |
|---|---|---|
| `.github/workflows/validate.yml` | PR validation (`typecheck`, `kb:check`) | currently fails with content validation errors |
| `.github/workflows/deploy-docs.yml` | main-branch artifact build/upload | builds `kb:build-all`, uploads `technical/artifacts/**` |
| `package.json` | script orchestration + dependency declarations | central runtime orchestration contract |
| `tsconfig.json` | TypeScript compile scope | includes `technical/scripts/**/*.ts` only |
| `technical/schemas/**` | static schema references | broader than currently active generated artifact set |
| `technical/artifacts/**` / `public/artifacts/**` | canonical and published machine outputs | currently synchronized for active files |
| `/Users/aran.berzingi/togetherai/inference.ts` | external inference consumer | hard-coupled generated tuple import |

---

## 4. Dependency Graph

### 4.1 Internal Dependency Graph (Directed)

Source: `technical/docs/architecture/library-system-intelligence-map.dependencies.adjlist`

Runtime import graph metrics:

- Nodes: `30`
- Edges: `49`
- Cycles: `0`

Central nodes by in-degree:

1. `technical/scripts/lib/io.ts` (`18`)
2. `technical/scripts/lib/structured_markdown.ts` (`6`)
3. `technical/scripts/lib/inference_mapping.ts` (`4`)
4. `technical/scripts/lib/cli_prompts.ts` (`3`)
5. `technical/scripts/lib/scaffold_catalog.ts` (`3`)

Central nodes by out-degree:

1. `technical/scripts/lib/scaffold/handlers.ts` (`8`)
2. `technical/scripts/lib/scaffold/prompts.ts` (`5`)
3. `technical/scripts/lib/scaffold/cli.ts` (`3`)
4. `technical/scripts/sync_schemas.ts` (`3`)

### 4.2 Graph Observations

- No direct circular imports detected.
- Runtime graph is intentionally acyclic but hub-heavy.
- `io.ts` is a single chokepoint for write/check/path behavior.
- Scaffold subsystem has dense internal coupling (`cli` -> `handlers` -> `prompts/indexes/references/provision/catalog`).

### 4.3 External Dependencies

Declared dependencies (`package.json`):

| Dependency | Classification | Role | Sensitivity |
|---|---|---|---|
| `tsx` | runtime toolchain | execute TS scripts directly | Medium |
| `typescript` | build-time | typechecking | Low |
| `fs-extra` | runtime/build | filesystem operations | Medium |
| `fast-glob` | runtime/build | filesystem discovery | Medium |
| `@inquirer/prompts` | runtime (interactive scaffold) | CLI prompt UX | Low |
| `zod` | declared, unused in code | none currently | Low (unused footprint) |
| `@types/node`, `@types/fs-extra` | build-time type support | types only | Low |

Node built-in dependencies used:

- `node:path`, `node:child_process`, `node:util`, `node:os`, `node:url`, `node:test`, `node:assert/strict`

### 4.4 Clean vs Leaky Layering Verdict

Leaky points:

- `verify_inference_equivalence.ts` assumes parent-directory `../inference.ts`.
- `build_relation_graph.ts` still expects `library/relations/**` (legacy path).
- Multiple docs/scripts still reflect migration-era path assumptions that are no longer true.

---

## 5. Data Flow Mapping

### 5.1 Input Sources

| Source | Location | Consumed By |
|---|---|---|
| Ontology markdown | `library/ontologies/**` | `validate_ontology.ts`, `sync_schemas.ts`, `build_json.ts`, `inference_mapping.ts` |
| Taxonomy concepts | `library/taxonomy/AML/concepts/**` | `inference_mapping.ts`, `scaffold_catalog.ts` |
| Taxonomy provision map | `library/taxonomy/AML/map/**` | `inference_mapping.ts`, `sync_taxonomy.ts`, `scaffold_catalog.ts` |
| Taxonomy indexes | `library/taxonomy/index_*.md` | scaffold index modules, `sync_taxonomy.ts` |
| Template markdown | `library/taxonomy/AML/_templates/**` | operator/scaffold authoring flows |
| Static schema docs | `technical/schemas/**` | reference and migration context |
| External hardcoded inference | `/Users/aran.berzingi/togetherai/inference.ts` | `verify_inference_equivalence.ts` |
| Workflow orchestration | `.github/workflows/**`, `package.json` | CI and local command chains |

Environment/process dependencies:

- Most scripts require `process.cwd()` to be repository root.
- `path_inventory.ts` requires `git` command availability.
- No env var-dependent logic detected in active code path.

### 5.2 Data Models and Validation Contracts

Primary entities:

- Ontology field specs (markdown -> normalized field objects -> JSON schema).
- Concept/provision/enforcement docs parsed in `inference_mapping.ts`.
- Relation bundles: `isSubtopics`, `topicMappings`, `statutoryViolations`.
- Scaffold catalog entries: jurisdictions, laws, chapter/paragraph/stycke/punkt options.
- Artifact manifest metadata.

Validation model:

- Structural markdown validation in `structured_markdown.ts`.
- Domain rules in `validate_ontology.ts` and `inference_mapping.ts`.
- Consistency checks between concept references and provision mappings.
- Dry-run drift detection via `--check` in generators.

### 5.3 State and Side Effects

State model:

- No persistent process state beyond execution lifecycle.
- Filesystem is the primary state store and side-effect boundary.

Side effects:

- file writes/removals in `library/**`, `technical/artifacts/**`, `public/artifacts/**`, `technical/docs/compass/**`
- CI artifact uploads from `technical/artifacts/**`

### 5.4 Data Flow Diagram

```text
[library/ontologies + library/taxonomy markdown]
                |
                v
[Parse + Validate]
  structured_markdown.ts
  validate_ontology.ts
  inference_mapping.ts
  sync_taxonomy.ts
                |
                v
[Generate]
  sync_schemas.ts -> technical/artifacts/schemas/**
  build_json.ts -> technical/artifacts/ontologies/**
  generate_manifest.ts -> technical/artifacts/manifest.json
  generate_inference_relations.ts -> library/taxonomy/generated/relations.generated.ts
  generate_cypher.ts -> library/taxonomy/generated/inference.cypher
                |
                v
[Publish]
  publish_artifacts.ts -> public/artifacts/**
                |
                +--> [CI validation/build workflows]
                +--> [/Users/.../inference.ts consumer]
```

---

## 6. Execution Flow Trace

### 6.1 Entry Points and Lifecycle

Entrypoints:

- `technical/scripts/*.ts`
- npm scripts in `package.json`
- `.github/workflows/*.yml`

Runtime lifecycle pattern:

1. npm invokes `tsx` on a script.
2. script resolves cwd-relative paths.
3. script reads/parses markdown/json/glob inputs.
4. script validates/transforms.
5. script writes outputs or exits non-zero.

Dependency injection:

- static import wiring only; no DI container.

### 6.2 Main Path Trace (`npm run kb:build-all`)

Execution order:

1. `kb:sync-schemas` -> schema generation
2. `kb:build-json` -> ontology JSON generation + prune removed scopes
3. `kb:manifest` -> artifact manifest generation
4. `kb:publish-artifacts` -> mirror to public artifacts

Primary outputs:

- `technical/artifacts/schemas/enforcement-actions/se.schema.json`
- `technical/artifacts/ontologies/enforcement-actions.json`
- `technical/artifacts/manifest.json`
- `public/artifacts/**`

### 6.3 Most Complex Path Trace (`npm run kb:check`)

Configured chain:

1. `kb:validate`
2. `kb:sync-schemas -- --check`
3. `kb:build-json -- --check`
4. `kb:manifest -- --check`
5. `taxonomy:check`
6. `taxonomy:validate-links`
7. `taxonomy:generate-relations -- --check`
8. `kb:generate-cypher -- --check`
9. `kb:verify-inference-equivalence`

Observed behavior in current repository state:

- Fails at step 1 because `Svea*.md` files miss required `affected_regulations` sections.
- Independent `taxonomy:validate-links` fails because `general_risk_assessment_product.md` is empty.
- Independent `kb:build-graph -- --check` fails due missing legacy `library/relations/relation-types.md`.

### 6.4 Background/Async Processes

Background automation is CI-only:

- PR workflow: install -> typecheck -> `kb:check`
- Main workflow: install -> `kb:build-all` -> upload artifacts

No daemon, worker, scheduler, or long-running async process exists.

### 6.5 Validation Command Outcomes (Required Set)

| Command | Exit | Outcome |
|---|---:|---|
| `npm run typecheck` | 0 | pass |
| `npm test` | 0 | pass (`70/70`) |
| `npm run kb:check` | 1 | fails in ontology validation |
| `npm run taxonomy:validate-links` | 1 | fails in taxonomy concept validation |
| `npm run kb:build-graph -- --check` | 1 | fails on missing legacy relation path |

---

## 7. Risk & Technical Debt Assessment

Severity legend:

- P0 Critical: correctness blockers
- P1 High: high operational/architectural risk
- P2 Medium: maintainability/testability/performance issues
- P3 Low: hygiene/optimization items

### 7.1 Findings (Ordered by Severity)

#### P0-1: Taxonomy corpus incompleteness blocks inference validation

Evidence:

- `24` empty files in `library/**`, concentrated under taxonomy concept/map trees.
- `taxonomy:validate-links` fails at `library/taxonomy/AML/concepts/general_risk_assessment/subconcepts/general_risk_assessment_product/general_risk_assessment_product.md` (missing required sections).

Impact:

- Inference relationship model is structurally incomplete.
- Generated graph artifacts may be partial/inaccurate relative to intended coverage.

Ambiguous interpretation:

1. Intentional placeholder scaffolding awaiting domain completion.
2. Migration gap where authoritative content has not been ported.

#### P0-2: Broken relation-graph path due legacy references

Evidence:

- `build_relation_graph.ts` references `library/relations/relation-types.md` and `library/relations/mappings/*.md`.
- Current repository has no `library/relations/**`; command fails with ENOENT.

Impact:

- Documented pipeline command is nonfunctional.
- Architectural documentation and executable behavior diverge.

#### P1-1: External parent-repo coupling for inference equivalence

Evidence:

- `verify_inference_equivalence.ts` hardcodes `../inference.ts` from repo cwd.

Impact:

- Reuse in isolated environments is fragile.
- CI portability depends on parent-folder layout.

#### P1-2: Monolithic complexity concentration

Evidence:

- `technical/scripts/lib/inference_mapping.ts` ~1991 lines.
- `technical/scripts/lib/scaffold/handlers.ts` ~1212 lines.
- `technical/scripts/sync_taxonomy.ts` ~897 lines.

Impact:

- Elevated regression risk per edit.
- Slower onboarding and lower code ownership clarity.

#### P1-3: Migration/documentation drift

Evidence:

- `typescript-migration.md` lists artifacts not emitted by current `kb:build-all` chain.
- Active outputs are narrower than documented relation/source artifact set.

Impact:

- Misleading operational expectations for auditors/onboardees.

#### P2-1: Hard path contracts and cwd assumptions

Evidence:

- Widespread hardcoded path literals, glob contracts, and `process.cwd()` assumptions.

Impact:

- Refactors/renames are expensive and brittle.

#### P2-2: Coverage skew toward libraries over entrypoint behavior

Evidence:

- `20` runtime modules are directly untested by module import coverage.

Impact:

- Script orchestration regressions may slip through.

#### P2-3: Duplicate/variant example naming and completeness inconsistency

Evidence:

- Multiple Svea example variants with non-uniform section completeness.

Impact:

- Confusion in source-of-truth selection and validation maintenance.

#### P3-1: Unused dependency footprint

Evidence:

- `zod` declared but unused.

Impact:

- Small but unnecessary maintenance/security surface.

### 7.2 Performance, Security, and Concurrency Notes

Performance:

- Repeated full-tree glob scans can be costly as corpus grows.
- Large monolithic parsing/validation modules amplify per-run CPU work.

Security-sensitive surfaces:

- Filesystem mutation operations (`remove`, `copy`, `writeFile`).
- Child process execution (`git ls-files`) in path inventory.

Concurrency:

- Pipeline assumes sequential operation.
- Parallel invocations could race on shared output files/directories.

---

## 8. Refactoring Roadmap

### 8.1 Ranked Actions (Impact / Risk / Effort)

| Priority | Action | Impact | Risk | Effort |
|---|---|---|---|---|
| 1 | Complete taxonomy content or explicitly gate placeholders from inference validation | Very High | Medium | Medium |
| 2 | Repair or retire `build_relation_graph.ts` legacy path assumptions | Very High | Low | Low |
| 3 | Parameterize inference equivalence target (repo-local default, optional external path) | High | Low | Low |
| 4 | Split `inference_mapping.ts` into parser/validator/model composer modules | High | Medium | High |
| 5 | Split scaffold handlers by command type and side-effect boundary | High | Medium | Medium |
| 6 | Introduce shared path-contract constants to remove hardcoded literals | High | Medium | Medium |
| 7 | Add integration tests for entry scripts (`kb:*`, `taxonomy:*`, publish) | Medium | Low | Medium |
| 8 | Add docs-vs-script drift checks in CI | Medium | Low | Low |
| 9 | Add safer write strategy (temp files + atomic rename, optional lock) | Medium | Medium | Medium |
| 10 | Remove unused dependencies and enforce dependency hygiene checks | Low | Low | Low |

### 8.2 Suggested Sequencing

1. Unblock failing validation/build paths.
2. Reduce monolith risk in core parsing/scaffold modules.
3. Improve orchestration reliability and testability.
4. Tighten docs/dependency hygiene.

### 8.3 Refactor Wave Acceptance Criteria

- `kb:check` passes on canonical content or has explicit placeholder-gating behavior.
- `kb:build-graph` is either functional or removed from active command surface.
- Equivalence verification no longer depends on fixed parent-folder structure.
- Core monolith modules are split with dedicated tests for each submodule.
- Architecture docs reflect actual generated outputs and script behavior.

---

## 9. Appendices

### Appendix A: Full Tree (Coupled Scope)

```text
├── .github
│   └── workflows
│       ├── deploy-docs.yml
│       └── validate.yml
├── library
│   ├── ontologies
│   │   └── document-types
│   │       ├── enforcement-actions
│   │       │   └── jurisdictions
│   │       │       └── se
│   │       │           ├── examples
│   │       │           │   └── enforcement-actions
│   │       │           │       ├── enforcement-action-Svea-Bank.md
│   │       │           │       ├── se-example-001.md
│   │       │           │       ├── Svea_bank.md
│   │       │           │       └── Svea.md
│   │       │           └── enforcement-actions.md
│   │       └── legislation
│   │           ├── jurisdictions
│   │           │   ├── EU
│   │           │   │   └── law.md
│   │           │   └── Sweden
│   │           │       └── law.md
│   │           └── law.md
│   └── taxonomy
│       ├── AML
│       │   ├── _templates
│       │   │   ├── concept_template.md
│       │   │   ├── enforcement_action_template.md
│       │   │   └── provision_template.md
│       │   ├── concepts
│       │   │   └── general_risk_assessment
│       │   │       ├── subconcepts
│       │   │       │   └── general_risk_assessment_product
│       │   │       │       └── general_risk_assessment_product.md
│       │   │       └── general_risk_assessment.md
│       │   └── map
│       │       ├── Denmark
│       │       │   ├── legislation
│       │       │   │   └── Hvidvaskloven (Lov nr. 651 af 8. juni 2017, as amended)
│       │       │   │       └── Level_1
│       │       │   │           └── Chapter_1
│       │       │   │               ├── Level_2
│       │       │   │               │   └── Paragraph_1
│       │       │   │               │       ├── Level_3
│       │       │   │               │       │   └── Stycke_1
│       │       │   │               │       │       └── Stycke_1.md
│       │       │   │               │       └── Paragraph_1.md
│       │       │   │               └── Chapter_1.md
│       │       │   └── Denmark.md
│       │       ├── EU
│       │       │   ├── legislation
│       │       │   │   ├── Directive (EU) 2015-849
│       │       │   │   │   └── Level_1
│       │       │   │   │       └── Chapter_1
│       │       │   │   │           ├── Level_2
│       │       │   │   │           │   └── Paragraph_1
│       │       │   │   │           │       ├── Level_3
│       │       │   │   │           │       │   └── Stycke_1
│       │       │   │   │           │       │       └── Stycke_1.md
│       │       │   │   │           │       └── Paragraph_1.md
│       │       │   │   │           └── Chapter_1.md
│       │       │   │   └── Directive (EU) 2018-843
│       │       │   │       └── Level_1
│       │       │   │           └── Chapter_1
│       │       │   │               ├── Level_2
│       │       │   │               │   └── Paragraph_1
│       │       │   │               │       ├── Level_3
│       │       │   │               │       │   └── Stycke_1
│       │       │   │               │       │       └── Stycke_1.md
│       │       │   │               │       └── Paragraph_1.md
│       │       │   │               └── Chapter_1.md
│       │       │   └── EU.md
│       │       ├── Norway
│       │       │   ├── legislation
│       │       │   │   └── Hvitvaskingsloven (LOV-2018-06-01-23)
│       │       │   │       └── Level_1
│       │       │   │           └── Chapter_1
│       │       │   │               ├── Level_2
│       │       │   │               │   └── Paragraph_1
│       │       │   │               │       ├── Level_3
│       │       │   │               │       │   └── Stycke_1
│       │       │   │               │       │       └── Stycke_1.md
│       │       │   │               │       └── Paragraph_1.md
│       │       │   │               └── Chapter_1.md
│       │       │   └── Norway.md
│       │       ├── Spain
│       │       │   ├── legislation
│       │       │   │   └── Ley 10-2010, de 28 de abril
│       │       │   │       └── Level_1
│       │       │   │           └── Chapter_1
│       │       │   │               ├── Level_2
│       │       │   │               │   └── Paragraph_1
│       │       │   │               │       ├── Level_3
│       │       │   │               │       │   └── Stycke_1
│       │       │   │               │       │       └── Stycke_1.md
│       │       │   │               │       └── Paragraph_1.md
│       │       │   │               └── Chapter_1.md
│       │       │   └── Spain.md
│       │       └── Sweden
│       │           ├── legislation
│       │           │   └── 2017:630
│       │           │       └── Level_1
│       │           │           └── Kapitel_1
│       │           │               ├── Level_2
│       │           │               │   └── Paragraf_2
│       │           │               │       ├── Level_3
│       │           │               │       │   └── Stycke_3
│       │           │               │       │       ├── Level_4
│       │           │               │       │       │   └── Punkt_3
│       │           │               │       │       │       └── Punkt_3.md
│       │           │               │       │       └── Stycke_3.md
│       │           │               │       └── Paragraf_2.md
│       │           │               └── Kapitel_1.md
│       │           └── Sweden.md
│       ├── generated
│       │   ├── inference.cypher
│       │   └── relations.generated.ts
│       ├── index_concepts.md
│       ├── index_enforcement_actions.md
│       └── index_jurisdiction.md
├── public
│   └── artifacts
│       ├── ontologies
│       │   └── enforcement-actions.json
│       ├── schemas
│       │   └── enforcement-actions
│       │       └── se.schema.json
│       └── manifest.json
├── technical
│   ├── artifacts
│   │   ├── ontologies
│   │   │   └── enforcement-actions.json
│   │   ├── schemas
│   │   │   └── enforcement-actions
│   │   │       └── se.schema.json
│   │   └── manifest.json
│   ├── docs
│   │   ├── architecture
│   │   │   ├── content-pipeline.md
│   │   │   ├── library-system-intelligence-map.dependencies.adjlist
│   │   │   ├── library-system-intelligence-map.inventory.tsv
│   │   │   ├── library-system-intelligence-map.md
│   │   │   ├── repository-boundaries.md
│   │   │   └── taxonomy-inference-pipeline.md
│   │   ├── compass
│   │   │   ├── index.md
│   │   │   └── paths.md
│   │   ├── migrations
│   │   │   ├── 2026-library-technical-reorg.md
│   │   │   └── typescript-migration.md
│   │   └── index.md
│   ├── schemas
│   │   ├── enforcement-actions
│   │   │   ├── dk.schema.json
│   │   │   ├── es.schema.json
│   │   │   ├── no.schema.json
│   │   │   └── se.schema.json
│   │   ├── aml-directive-mapping.schema.json
│   │   ├── ontology-base.schema.json
│   │   └── relation.schema.json
│   └── scripts
│       ├── lib
│       │   ├── scaffold
│       │   │   ├── cli.ts
│       │   │   ├── handlers.ts
│       │   │   ├── indexes.ts
│       │   │   ├── paths.ts
│       │   │   ├── prompts.ts
│       │   │   ├── provision_files.ts
│       │   │   ├── references.ts
│       │   │   └── types.ts
│       │   ├── cli_prompts.ts
│       │   ├── inference_mapping.ts
│       │   ├── io.ts
│       │   ├── path_inventory.ts
│       │   ├── scaffold_catalog.ts
│       │   ├── schema.ts
│       │   └── structured_markdown.ts
│       ├── tests
│       │   ├── cli_prompts.test.ts
│       │   ├── inference_mapping.test.ts
│       │   ├── scaffold_catalog.test.ts
│       │   ├── scaffold_cli.test.ts
│       │   ├── scaffold_handlers_back.test.ts
│       │   ├── scaffold_indexes.test.ts
│       │   ├── scaffold_prompts_back.test.ts
│       │   ├── scaffold_references.test.ts
│       │   ├── scaffold.test.ts
│       │   ├── structured_markdown.test.ts
│       │   └── test_fs.ts
│       ├── build_json.ts
│       ├── build_relation_graph.ts
│       ├── generate_compass.ts
│       ├── generate_cypher.ts
│       ├── generate_inference_relations.ts
│       ├── generate_manifest.ts
│       ├── generate_paths.ts
│       ├── publish_artifacts.ts
│       ├── scaffold.ts
│       ├── sync_schemas.ts
│       ├── sync_taxonomy.ts
│       ├── validate_ontology.ts
│       ├── validate_taxonomy_mappings.ts
│       └── verify_inference_equivalence.ts
├── AGENTS.md
├── package.json
├── README.md
└── tsconfig.json
```

### Appendix B: Full Tree (`library/**`)

```text
library/
├── ontologies
│   └── document-types
│       ├── enforcement-actions
│       │   └── jurisdictions
│       │       └── se
│       │           ├── examples
│       │           │   └── enforcement-actions
│       │           │       ├── enforcement-action-Svea-Bank.md
│       │           │       ├── se-example-001.md
│       │           │       ├── Svea_bank.md
│       │           │       └── Svea.md
│       │           └── enforcement-actions.md
│       └── legislation
│           ├── jurisdictions
│           │   ├── EU
│           │   │   └── law.md
│           │   └── Sweden
│           │       └── law.md
│           └── law.md
└── taxonomy
    ├── AML
    │   ├── _templates
    │   │   ├── concept_template.md
    │   │   ├── enforcement_action_template.md
    │   │   └── provision_template.md
    │   ├── concepts
    │   │   └── general_risk_assessment
    │   │       ├── subconcepts
    │   │       │   └── general_risk_assessment_product
    │   │       │       └── general_risk_assessment_product.md
    │   │       └── general_risk_assessment.md
    │   └── map
    │       ├── Denmark
    │       │   ├── legislation
    │       │   │   └── Hvidvaskloven (Lov nr. 651 af 8. juni 2017, as amended)
    │       │   │       └── Level_1
    │       │   │           └── Chapter_1
    │       │   │               ├── Level_2
    │       │   │               │   └── Paragraph_1
    │       │   │               │       ├── Level_3
    │       │   │               │       │   └── Stycke_1
    │       │   │               │       │       └── Stycke_1.md
    │       │   │               │       └── Paragraph_1.md
    │       │   │               └── Chapter_1.md
    │       │   └── Denmark.md
    │       ├── EU
    │       │   ├── legislation
    │       │   │   ├── Directive (EU) 2015-849
    │       │   │   │   └── Level_1
    │       │   │   │       └── Chapter_1
    │       │   │   │           ├── Level_2
    │       │   │   │           │   └── Paragraph_1
    │       │   │   │           │       ├── Level_3
    │       │   │   │           │       │   └── Stycke_1
    │       │   │   │           │       │       └── Stycke_1.md
    │       │   │   │           │       └── Paragraph_1.md
    │       │   │   │           └── Chapter_1.md
    │       │   │   └── Directive (EU) 2018-843
    │       │   │       └── Level_1
    │       │   │           └── Chapter_1
    │       │   │               ├── Level_2
    │       │   │               │   └── Paragraph_1
    │       │   │               │       ├── Level_3
    │       │   │               │       │   └── Stycke_1
    │       │   │               │       │       └── Stycke_1.md
    │       │   │               │       └── Paragraph_1.md
    │       │   │               └── Chapter_1.md
    │       │   └── EU.md
    │       ├── Norway
    │       │   ├── legislation
    │       │   │   └── Hvitvaskingsloven (LOV-2018-06-01-23)
    │       │   │       └── Level_1
    │       │   │           └── Chapter_1
    │       │   │               ├── Level_2
    │       │   │               │   └── Paragraph_1
    │       │   │               │       ├── Level_3
    │       │   │               │       │   └── Stycke_1
    │       │   │               │       │       └── Stycke_1.md
    │       │   │               │       └── Paragraph_1.md
    │       │   │               └── Chapter_1.md
    │       │   └── Norway.md
    │       ├── Spain
    │       │   ├── legislation
    │       │   │   └── Ley 10-2010, de 28 de abril
    │       │   │       └── Level_1
    │       │   │           └── Chapter_1
    │       │   │               ├── Level_2
    │       │   │               │   └── Paragraph_1
    │       │   │               │       ├── Level_3
    │       │   │               │       │   └── Stycke_1
    │       │   │               │       │       └── Stycke_1.md
    │       │   │               │       └── Paragraph_1.md
    │       │   │               └── Chapter_1.md
    │       │   └── Spain.md
    │       └── Sweden
    │           ├── legislation
    │           │   └── 2017:630
    │           │       └── Level_1
    │           │           └── Kapitel_1
    │           │               ├── Level_2
    │           │               │   └── Paragraf_2
    │           │               │       ├── Level_3
    │           │               │       │   └── Stycke_3
    │           │               │       │       ├── Level_4
    │           │               │       │       │   └── Punkt_3
    │           │               │       │       │       └── Punkt_3.md
    │           │               │       │       └── Stycke_3.md
    │           │               │       └── Paragraf_2.md
    │           │               └── Kapitel_1.md
    │           └── Sweden.md
    ├── generated
    │   ├── inference.cypher
    │   └── relations.generated.ts
    ├── index_concepts.md
    ├── index_enforcement_actions.md
    └── index_jurisdiction.md
```

### Appendix C: Inventory Statistics Snapshot

```text
TOTAL_FILES	123
TOTAL_BYTES	562492
TOTAL_LINES	17483
EMPTY_FILES	24
BY_SCOPE
.github	2
external-coupled	1
library	42
public	3
root-config	4
technical	61
BY_EXT
adjlist	1
cypher	1
json	15
md	61
ts	42
tsv	1
yml	2
EMPTY_BY_SCOPE
library	24
TOP_BYTES
83064	technical/docs/architecture/library-system-intelligence-map.md
55135	technical/scripts/lib/inference_mapping.ts
33992	technical/scripts/lib/scaffold/handlers.ts
26686	technical/scripts/sync_taxonomy.ts
24486	technical/docs/architecture/library-system-intelligence-map.dependencies.adjlist
23600	technical/scripts/lib/scaffold/prompts.ts
18828	technical/scripts/lib/scaffold_catalog.ts
17184	technical/scripts/validate_ontology.ts
16262	technical/docs/compass/paths.md
15618	technical/scripts/tests/inference_mapping.test.ts
13082	technical/scripts/lib/structured_markdown.ts
12845	technical/scripts/lib/cli_prompts.ts
11275	technical/scripts/tests/cli_prompts.test.ts
10973	technical/schemas/aml-directive-mapping.schema.json
10091	technical/scripts/lib/scaffold/indexes.ts
TOP_LINES
1991	technical/scripts/lib/inference_mapping.ts
1469	technical/docs/architecture/library-system-intelligence-map.md
1212	technical/scripts/lib/scaffold/handlers.ts
897	technical/scripts/sync_taxonomy.ts
826	technical/scripts/lib/scaffold/prompts.ts
655	technical/scripts/tests/inference_mapping.test.ts
649	technical/scripts/lib/scaffold_catalog.ts
560	technical/scripts/validate_ontology.ts
508	technical/scripts/lib/cli_prompts.ts
486	technical/scripts/lib/structured_markdown.ts
375	technical/schemas/aml-directive-mapping.schema.json
375	technical/scripts/tests/cli_prompts.test.ts
353	technical/scripts/lib/scaffold/indexes.ts
294	technical/scripts/tests/structured_markdown.test.ts
```

### Appendix D: Empty Source Files (`library/**`)

```text
library/taxonomy/AML/concepts/general_risk_assessment/subconcepts/general_risk_assessment_product/general_risk_assessment_product.md
library/taxonomy/AML/map/Denmark/Denmark.md
library/taxonomy/AML/map/Denmark/legislation/Hvidvaskloven (Lov nr. 651 af 8. juni 2017, as amended)/Level_1/Chapter_1/Chapter_1.md
library/taxonomy/AML/map/Denmark/legislation/Hvidvaskloven (Lov nr. 651 af 8. juni 2017, as amended)/Level_1/Chapter_1/Level_2/Paragraph_1/Level_3/Stycke_1/Stycke_1.md
library/taxonomy/AML/map/Denmark/legislation/Hvidvaskloven (Lov nr. 651 af 8. juni 2017, as amended)/Level_1/Chapter_1/Level_2/Paragraph_1/Paragraph_1.md
library/taxonomy/AML/map/EU/EU.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2015-849/Level_1/Chapter_1/Chapter_1.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2015-849/Level_1/Chapter_1/Level_2/Paragraph_1/Level_3/Stycke_1/Stycke_1.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2015-849/Level_1/Chapter_1/Level_2/Paragraph_1/Paragraph_1.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2018-843/Level_1/Chapter_1/Chapter_1.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2018-843/Level_1/Chapter_1/Level_2/Paragraph_1/Level_3/Stycke_1/Stycke_1.md
library/taxonomy/AML/map/EU/legislation/Directive (EU) 2018-843/Level_1/Chapter_1/Level_2/Paragraph_1/Paragraph_1.md
library/taxonomy/AML/map/Norway/Norway.md
library/taxonomy/AML/map/Norway/legislation/Hvitvaskingsloven (LOV-2018-06-01-23)/Level_1/Chapter_1/Chapter_1.md
library/taxonomy/AML/map/Norway/legislation/Hvitvaskingsloven (LOV-2018-06-01-23)/Level_1/Chapter_1/Level_2/Paragraph_1/Level_3/Stycke_1/Stycke_1.md
library/taxonomy/AML/map/Norway/legislation/Hvitvaskingsloven (LOV-2018-06-01-23)/Level_1/Chapter_1/Level_2/Paragraph_1/Paragraph_1.md
library/taxonomy/AML/map/Spain/Spain.md
library/taxonomy/AML/map/Spain/legislation/Ley 10-2010, de 28 de abril/Level_1/Chapter_1/Chapter_1.md
library/taxonomy/AML/map/Spain/legislation/Ley 10-2010, de 28 de abril/Level_1/Chapter_1/Level_2/Paragraph_1/Level_3/Stycke_1/Stycke_1.md
library/taxonomy/AML/map/Spain/legislation/Ley 10-2010, de 28 de abril/Level_1/Chapter_1/Level_2/Paragraph_1/Paragraph_1.md
library/taxonomy/AML/map/Sweden/Sweden.md
library/taxonomy/AML/map/Sweden/legislation/2017:630/Level_1/Kapitel_1/Kapitel_1.md
library/taxonomy/AML/map/Sweden/legislation/2017:630/Level_1/Kapitel_1/Level_2/Paragraf_2/Level_3/Stycke_3/Stycke_3.md
library/taxonomy/AML/map/Sweden/legislation/2017:630/Level_1/Kapitel_1/Level_2/Paragraf_2/Paragraf_2.md
```

### Appendix E: Runtime Dependency Graph Metrics

```text
NODES	30
EDGES	49
TOP_IN
18	technical/scripts/lib/io.ts
6	technical/scripts/lib/structured_markdown.ts
4	technical/scripts/lib/inference_mapping.ts
3	technical/scripts/lib/cli_prompts.ts
3	technical/scripts/lib/scaffold_catalog.ts
3	technical/scripts/lib/scaffold/references.ts
2	technical/scripts/lib/path_inventory.ts
2	technical/scripts/lib/scaffold/indexes.ts
2	technical/scripts/lib/scaffold/paths.ts
1	library/taxonomy/generated/relations.generated.ts
1	technical/scripts/lib/scaffold/cli.ts
1	technical/scripts/lib/scaffold/handlers.ts
1	technical/scripts/lib/scaffold/prompts.ts
1	technical/scripts/lib/scaffold/provision_files.ts
1	technical/scripts/lib/schema.ts
0	/Users/aran.berzingi/togetherai/inference.ts
0	technical/scripts/build_json.ts
0	technical/scripts/build_relation_graph.ts
0	technical/scripts/generate_compass.ts
0	technical/scripts/generate_cypher.ts
TOP_OUT
8	technical/scripts/lib/scaffold/handlers.ts
5	technical/scripts/lib/scaffold/prompts.ts
3	technical/scripts/lib/scaffold/cli.ts
3	technical/scripts/sync_schemas.ts
2	technical/scripts/build_json.ts
2	technical/scripts/build_relation_graph.ts
2	technical/scripts/generate_compass.ts
2	technical/scripts/generate_cypher.ts
2	technical/scripts/generate_inference_relations.ts
2	technical/scripts/generate_paths.ts
2	technical/scripts/lib/inference_mapping.ts
2	technical/scripts/lib/scaffold/provision_files.ts
2	technical/scripts/validate_ontology.ts
2	technical/scripts/verify_inference_equivalence.ts
1	/Users/aran.berzingi/togetherai/inference.ts
1	technical/scripts/generate_manifest.ts
1	technical/scripts/lib/scaffold_catalog.ts
1	technical/scripts/lib/scaffold/indexes.ts
1	technical/scripts/lib/scaffold/paths.ts
1	technical/scripts/lib/schema.ts
CYCLES	0
```

### Appendix F: Directly Untested Runtime Modules

```text
RUNTIME_MODULES	29
DIRECTLY_TESTED_MODULES	10
DIRECTLY_UNTESTED_MODULES	20
technical/scripts/build_json.ts
technical/scripts/build_relation_graph.ts
technical/scripts/generate_compass.ts
technical/scripts/generate_cypher.ts
technical/scripts/generate_inference_relations.ts
technical/scripts/generate_manifest.ts
technical/scripts/generate_paths.ts
technical/scripts/lib/io.ts
technical/scripts/lib/path_inventory.ts
technical/scripts/lib/scaffold/paths.ts
technical/scripts/lib/scaffold/provision_files.ts
technical/scripts/lib/scaffold/types.ts
technical/scripts/lib/schema.ts
technical/scripts/publish_artifacts.ts
technical/scripts/scaffold.ts
technical/scripts/sync_schemas.ts
technical/scripts/sync_taxonomy.ts
technical/scripts/validate_ontology.ts
technical/scripts/validate_taxonomy_mappings.ts
technical/scripts/verify_inference_equivalence.ts
```

### Appendix G: Command Evidence (Required Checks)

`npm run typecheck`:

```text

> regulatory-kb@1.0.0 typecheck
> tsc --noEmit

```

`npm test`:

```text

> regulatory-kb@1.0.0 test
> node --test --test-concurrency=1 --import tsx technical/scripts/tests/*.test.ts

✔ selectOrCustom returns existing value without custom input (0.874333ms)
✔ selectOrCustom uses custom path and retries until validation succeeds (0.213916ms)
✔ selectOptionalNumberOrCustom returns undefined when Skip is selected (0.19125ms)
✔ selectOptionalNumberOrCustom accepts prefixed custom values (0.237333ms)
✔ selectOptionalNumberOrCustom treats blank custom input as skip for optional prompts (0.118875ms)
✔ inputValidatedWithBack returns BACK sentinel for /back (case-insensitive) (0.105584ms)
✔ selectOrCustomWithBack returns BACK when Back is selected (0.159041ms)
✔ selectOrCustomWithBack returns BACK when /back is entered in custom input (0.10625ms)
✔ selectOptionalNumberOrCustomWithBack returns BACK when Back is selected (0.178917ms)
✔ selectOptionalNumberOrCustomWithBack treats blank custom input as skip for optional prompts (0.192667ms)
✔ selectYesNoBack returns BACK when Back is selected (0.113625ms)
✔ checkboxWithBack returns BACK when Back is selected with other values (0.182709ms)
✔ inputValidated trims user input and applies validation (0.108541ms)
✔ parseConceptReferencesSection parses legacy canonical bullets (1.612958ms)
✔ parseConceptReferencesSection parses structured Sweden blocks with aliases and prefixes (0.414459ms)
✔ parseConceptReferencesSection rejects mixed canonical and structured formats (0.331042ms)
...
ℹ tests 70
ℹ pass 70
ℹ fail 0
ℹ duration_ms 4134.202083
```

`npm run kb:check`:

```text

> regulatory-kb@1.0.0 kb:check
> npm run kb:validate && npm run kb:sync-schemas -- --check && npm run kb:build-json -- --check && npm run kb:manifest -- --check && npm run taxonomy:check && npm run taxonomy:validate-links && npm run taxonomy:generate-relations -- --check && npm run kb:generate-cypher -- --check && npm run kb:verify-inference-equivalence


> regulatory-kb@1.0.0 kb:validate
> tsx technical/scripts/validate_ontology.ts

Validating ontology files...
  ERROR [library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/Svea_bank.md]: Missing required section 'affected_regulations'
  ERROR [library/ontologies/document-types/enforcement-actions/jurisdictions/se/examples/enforcement-actions/Svea.md]: Missing required section 'affected_regulations'

2 error(s), 0 warning(s)
```

`npm run taxonomy:validate-links`:

```text

> regulatory-kb@1.0.0 taxonomy:validate-links
> tsx technical/scripts/validate_taxonomy_mappings.ts

library/taxonomy/AML/concepts/general_risk_assessment/subconcepts/general_risk_assessment_product/general_risk_assessment_product.md: concept/subconcept files must contain '## metadata' and '## references'
```

`npm run kb:build-graph -- --check`:

```text

> regulatory-kb@1.0.0 kb:build-graph
> tsx technical/scripts/build_relation_graph.ts --check

ENOENT: no such file or directory, open '/Users/aran.berzingi/togetherai/regulatory-kb/library/relations/relation-types.md'
```

### Appendix H: Direct Test-to-Module Coverage Map

```text
BY_TEST
technical/scripts/tests/cli_prompts.test.ts	technical/scripts/lib/cli_prompts.ts
technical/scripts/tests/inference_mapping.test.ts	technical/scripts/lib/inference_mapping.ts, technical/scripts/tests/test_fs.ts
technical/scripts/tests/scaffold_catalog.test.ts	technical/scripts/lib/scaffold_catalog.ts, technical/scripts/tests/test_fs.ts
technical/scripts/tests/scaffold_cli.test.ts	technical/scripts/lib/scaffold/cli.ts
technical/scripts/tests/scaffold_handlers_back.test.ts	technical/scripts/lib/cli_prompts.ts, technical/scripts/lib/scaffold/handlers.ts, technical/scripts/lib/scaffold_catalog.ts, technical/scripts/tests/test_fs.ts
technical/scripts/tests/scaffold_indexes.test.ts	technical/scripts/lib/scaffold/indexes.ts, technical/scripts/tests/test_fs.ts
technical/scripts/tests/scaffold_prompts_back.test.ts	technical/scripts/lib/cli_prompts.ts, technical/scripts/lib/scaffold/prompts.ts, technical/scripts/lib/scaffold_catalog.ts, technical/scripts/tests/test_fs.ts
technical/scripts/tests/scaffold_references.test.ts	technical/scripts/lib/scaffold/references.ts
technical/scripts/tests/scaffold.test.ts	technical/scripts/tests/test_fs.ts
technical/scripts/tests/structured_markdown.test.ts	technical/scripts/lib/structured_markdown.ts, technical/scripts/tests/test_fs.ts
BY_TARGET
technical/scripts/lib/cli_prompts.ts	3	technical/scripts/tests/cli_prompts.test.ts, technical/scripts/tests/scaffold_handlers_back.test.ts, technical/scripts/tests/scaffold_prompts_back.test.ts
technical/scripts/lib/inference_mapping.ts	1	technical/scripts/tests/inference_mapping.test.ts
technical/scripts/lib/scaffold_catalog.ts	3	technical/scripts/tests/scaffold_catalog.test.ts, technical/scripts/tests/scaffold_handlers_back.test.ts, technical/scripts/tests/scaffold_prompts_back.test.ts
technical/scripts/lib/scaffold/cli.ts	1	technical/scripts/tests/scaffold_cli.test.ts
technical/scripts/lib/scaffold/handlers.ts	1	technical/scripts/tests/scaffold_handlers_back.test.ts
technical/scripts/lib/scaffold/indexes.ts	1	technical/scripts/tests/scaffold_indexes.test.ts
technical/scripts/lib/scaffold/prompts.ts	1	technical/scripts/tests/scaffold_prompts_back.test.ts
technical/scripts/lib/scaffold/references.ts	1	technical/scripts/tests/scaffold_references.test.ts
technical/scripts/lib/structured_markdown.ts	1	technical/scripts/tests/structured_markdown.test.ts
technical/scripts/tests/test_fs.ts	7	technical/scripts/tests/inference_mapping.test.ts, technical/scripts/tests/scaffold.test.ts, technical/scripts/tests/scaffold_catalog.test.ts, technical/scripts/tests/scaffold_handlers_back.test.ts, technical/scripts/tests/scaffold_indexes.test.ts, technical/scripts/tests/scaffold_prompts_back.test.ts, technical/scripts/tests/structured_markdown.test.ts
```

### Appendix I: Exported TypeScript Interfaces and Functions (Non-test Modules)

```text
technical/scripts/lib/scaffold/cli.ts:10:export function parseCliOptionMap(args: string[]): Map<string, string> {
technical/scripts/lib/scaffold/cli.ts:36:export async function runScaffoldCli(argv: string[] = process.argv.slice(2)): Promise<void> {
technical/scripts/lib/io.ts:5:export interface RunOptions {
technical/scripts/lib/io.ts:9:export function getRunOptions(argv: string[]): RunOptions {
technical/scripts/lib/io.ts:15:export function repoPath(...parts: string[]): string {
technical/scripts/lib/io.ts:19:export function toPosixRelative(filePath: string): string {
technical/scripts/lib/io.ts:23:export async function ensureParentDir(filePath: string): Promise<void> {
technical/scripts/lib/io.ts:27:export function stableJson(data: unknown): string {
technical/scripts/lib/io.ts:31:export function stableText(text: string): string {
technical/scripts/lib/io.ts:35:export interface WriteResult {
technical/scripts/lib/io.ts:40:export async function writeJsonFile(
technical/scripts/lib/io.ts:65:export async function writeTextFile(
technical/scripts/lib/io.ts:90:export async function listJsonFiles(rootDir: string): Promise<string[]> {
technical/scripts/lib/schema.ts:24:export function fieldToJsonSchema(fieldDef: Record<string, unknown>): Record<string, unknown> {
technical/scripts/lib/schema.ts:100:export function enumSetFromField(fieldDef: unknown): Set<string> {
technical/scripts/lib/cli_prompts.ts:8:export interface SelectChoice<T> {
technical/scripts/lib/cli_prompts.ts:15:export interface CheckboxChoice<T> extends SelectChoice<T> {
technical/scripts/lib/cli_prompts.ts:19:export interface PromptAdapter {
technical/scripts/lib/cli_prompts.ts:43:export const BACK_SENTINEL = '__codex_back__' as const;
technical/scripts/lib/cli_prompts.ts:44:export const BACK_INPUT_TOKEN = '/back';
technical/scripts/lib/cli_prompts.ts:46:export function isBackSentinel(value: unknown): value is typeof BACK_SENTINEL {
technical/scripts/lib/cli_prompts.ts:50:export const interactivePromptAdapter: PromptAdapter = {
technical/scripts/lib/cli_prompts.ts:102:export async function inputValidated(
technical/scripts/lib/cli_prompts.ts:127:export async function inputValidatedWithBack(
technical/scripts/lib/cli_prompts.ts:156:export async function selectOrCustom(
technical/scripts/lib/cli_prompts.ts:203:export async function selectOrCustomWithBack(
technical/scripts/lib/cli_prompts.ts:284:export async function selectOptionalNumberOrCustom(
technical/scripts/lib/cli_prompts.ts:351:export async function selectOptionalNumberOrCustomWithBack(
technical/scripts/lib/cli_prompts.ts:454:export async function selectYesNoBack(
technical/scripts/lib/cli_prompts.ts:477:export async function checkboxWithBack<T>(
technical/scripts/lib/scaffold_catalog.ts:40:export interface LawCatalog {
technical/scripts/lib/scaffold_catalog.ts:49:export interface JurisdictionCatalog {
technical/scripts/lib/scaffold_catalog.ts:54:export interface ScaffoldCatalog {
technical/scripts/lib/scaffold_catalog.ts:144:export function extractLawCodeCandidates(value: string): string[] {
technical/scripts/lib/scaffold_catalog.ts:577:export function findJurisdictionCatalog(
technical/scripts/lib/scaffold_catalog.ts:585:export function findLawCatalog(
technical/scripts/lib/scaffold_catalog.ts:597:export function getParagraphNumbers(law: LawCatalog | undefined, chapter: number): number[] {
technical/scripts/lib/scaffold_catalog.ts:604:export function getStyckeNumbers(
technical/scripts/lib/scaffold_catalog.ts:615:export function getPunktNumbers(
technical/scripts/lib/scaffold_catalog.ts:627:export async function loadScaffoldCatalog(): Promise<ScaffoldCatalog> {
technical/scripts/lib/inference_mapping.ts:13:export interface TopicMappingRow {
technical/scripts/lib/inference_mapping.ts:18:export interface IsSubtopicRow {
technical/scripts/lib/inference_mapping.ts:23:export interface StatutoryViolationRow {
technical/scripts/lib/inference_mapping.ts:28:export interface InferenceRelationBundle {
technical/scripts/lib/inference_mapping.ts:735:export function parseConceptReferencesSection(
technical/scripts/lib/inference_mapping.ts:1848:export async function loadInferenceMappingModel(): Promise<{
technical/scripts/lib/path_inventory.ts:8:export interface PathInventory {
technical/scripts/lib/path_inventory.ts:43:export async function listRepositoryFiles(): Promise<string[]> {
technical/scripts/lib/path_inventory.ts:74:export async function getPathInventory(): Promise<PathInventory> {
technical/scripts/lib/scaffold/handlers.ts:67:export async function scaffoldConcept(
technical/scripts/lib/scaffold/handlers.ts:271:export async function scaffoldProvision(
technical/scripts/lib/scaffold/handlers.ts:628:export async function validateConceptIdsExist(conceptIds: string[]): Promise<string[]> {
technical/scripts/lib/scaffold/handlers.ts:824:export async function scaffoldEnforcementAction(
technical/scripts/lib/scaffold/handlers.ts:1112:export async function scaffoldEnforcementActionFromCliOptions(
technical/scripts/lib/scaffold/indexes.ts:158:export function ensureNode(
technical/scripts/lib/scaffold/indexes.ts:174:export async function readConceptIndex(): Promise<ConceptEntry[]> {
technical/scripts/lib/scaffold/indexes.ts:209:export async function writeConceptIndex(concepts: ConceptEntry[]): Promise<void> {
technical/scripts/lib/scaffold/indexes.ts:224:export async function readJurisdictionIndex(): Promise<JurisdictionEntry[]> {
technical/scripts/lib/scaffold/indexes.ts:280:export async function writeJurisdictionIndex(
technical/scripts/lib/scaffold/indexes.ts:316:export async function readEnforcementActionIndex(): Promise<EnforcementActionEntry[]> {
technical/scripts/lib/scaffold/indexes.ts:343:export async function writeEnforcementActionIndex(
technical/scripts/lib/structured_markdown.ts:5:export interface StructuredMarkdownDoc {
technical/scripts/lib/structured_markdown.ts:12:export interface MarkdownValidationRule {
technical/scripts/lib/structured_markdown.ts:32:export function extractMarkdownSections(markdown: string): Record<string, string> {
technical/scripts/lib/structured_markdown.ts:69:export function assertNoMarkdownTables(filePath: string, raw: string): void {
technical/scripts/lib/structured_markdown.ts:79:export function parseKeyValueBullets(
technical/scripts/lib/structured_markdown.ts:116:export function parseSubsectionBlocks(
technical/scripts/lib/structured_markdown.ts:169:export function parseBulletList(
technical/scripts/lib/structured_markdown.ts:381:export async function readStructuredMarkdownDoc(
technical/scripts/lib/structured_markdown.ts:417:export async function globMarkdown(patterns: string | string[]): Promise<string[]> {
technical/scripts/lib/structured_markdown.ts:453:export function fieldsToMap(fields: unknown): Record<string, Record<string, unknown>> {
technical/scripts/lib/structured_markdown.ts:469:export function fieldListToProperties(
technical/scripts/lib/structured_markdown.ts:475:export function getEnumValues(fieldDef: unknown): string[] {
technical/scripts/lib/scaffold/provision_files.ts:7:export function levelLabel(level: number): string {
technical/scripts/lib/scaffold/provision_files.ts:14:export function levelName(level: number, value: number): string {
technical/scripts/lib/scaffold/provision_files.ts:21:export async function ensureProvisionFile(
technical/scripts/lib/scaffold/paths.ts:3:export function indexConceptsPath(): string {
technical/scripts/lib/scaffold/paths.ts:7:export function indexJurisdictionPath(): string {
technical/scripts/lib/scaffold/paths.ts:11:export function indexEnforcementActionsPath(): string {
technical/scripts/lib/scaffold/paths.ts:15:export function conceptFileRef(conceptSlug: string): string {
technical/scripts/lib/scaffold/paths.ts:19:export function subconceptFileRef(
technical/scripts/lib/scaffold/paths.ts:26:export function jurisdictionFileRef(jurisdictionName: string): string {
technical/scripts/lib/scaffold/paths.ts:30:export function lawDirectoryRef(jurisdictionName: string, lawName: string): string {
technical/scripts/lib/scaffold/paths.ts:34:export function enforcementActionFileRef(slug: string): string {
technical/scripts/lib/scaffold/references.ts:4:export const SWEDEN_LAW_DEFAULT =
technical/scripts/lib/scaffold/references.ts:12:export function toConceptId(slug: string): string {
technical/scripts/lib/scaffold/references.ts:19:export function parseCsv(value: string): string[] {
technical/scripts/lib/scaffold/references.ts:26:export function toProvisionAddress(
technical/scripts/lib/scaffold/references.ts:46:export function parsePositiveIntegerComponent(
technical/scripts/lib/scaffold/references.ts:75:export function parseRequiredPositiveIntegerComponent(
technical/scripts/lib/scaffold/references.ts:87:export function parseLawCode(value: string): string {
technical/scripts/lib/scaffold/references.ts:105:export function parseLawCodeValidationMessage(value: string): string | undefined {
technical/scripts/lib/scaffold/references.ts:114:export function normalizeJurisdiction(value: string): 'SE' {
technical/scripts/lib/scaffold/references.ts:124:export function normalizeDiarienummer(value: string): {
technical/scripts/lib/scaffold/references.ts:144:export function buildEnforcementReferenceId(
technical/scripts/lib/scaffold/references.ts:157:export function dedupeAndSort(values: string[]): string[] {
technical/scripts/lib/scaffold/references.ts:163:export function parseSwedishAddress(address: string): {
technical/scripts/lib/scaffold/references.ts:184:export function formatStructuredConceptReferences(addresses: string[]): string[] {
technical/scripts/lib/scaffold/references.ts:212:export function parseAndValidateConceptId(value: string): string {
technical/scripts/lib/scaffold/references.ts:225:export function validateDecisionType(value: string): DecisionType {
technical/scripts/lib/scaffold/references.ts:235:export function validateFineFlag(value: string): 'yes' | 'no' {
technical/scripts/lib/scaffold/types.ts:1:export interface ConceptEntry {
technical/scripts/lib/scaffold/types.ts:7:export interface SubconceptEntry {
technical/scripts/lib/scaffold/types.ts:12:export interface ProvisionNode {
technical/scripts/lib/scaffold/types.ts:18:export interface LawEntry {
technical/scripts/lib/scaffold/types.ts:23:export interface JurisdictionEntry {
technical/scripts/lib/scaffold/types.ts:28:export interface EnforcementActionEntry {
technical/scripts/lib/scaffold/types.ts:33:export const DECISION_TYPES = [
technical/scripts/lib/scaffold/types.ts:42:export type DecisionType = (typeof DECISION_TYPES)[number];
technical/scripts/lib/scaffold/prompts.ts:55:export async function promptLawCode(
technical/scripts/lib/scaffold/prompts.ts:82:export async function promptLawCodeWithBack(
technical/scripts/lib/scaffold/prompts.ts:130:export async function promptSwedishAddressWithBack(
technical/scripts/lib/scaffold/prompts.ts:434:export async function promptSwedishAddress(
technical/scripts/lib/scaffold/prompts.ts:528:export async function promptStatutoryReferences(
technical/scripts/lib/scaffold/prompts.ts:562:export async function promptStatutoryReferencesWithBack(
technical/scripts/lib/scaffold/prompts.ts:659:export async function loadKnownConceptIds(): Promise<Set<string>> {
technical/scripts/lib/scaffold/prompts.ts:682:export async function promptConceptsCovered(prompt: PromptAdapter): Promise<string[]> {
technical/scripts/lib/scaffold/prompts.ts:721:export async function promptConceptsCoveredWithBack(
library/taxonomy/generated/relations.generated.ts:4:export interface IsSubtopicRow {
library/taxonomy/generated/relations.generated.ts:9:export interface TopicMappingRow {
library/taxonomy/generated/relations.generated.ts:14:export interface StatutoryViolationRow {
library/taxonomy/generated/relations.generated.ts:19:export const isSubtopics: IsSubtopicRow[] = [
library/taxonomy/generated/relations.generated.ts:26:export const topicMappings: TopicMappingRow[] = [
library/taxonomy/generated/relations.generated.ts:42:export const statutoryViolations: StatutoryViolationRow[] = [
```

### Appendix J: Deliverable Files

- Report: `technical/docs/architecture/library-system-intelligence-map.md`
- Inventory: `technical/docs/architecture/library-system-intelligence-map.inventory.tsv`
- Dependency graph adjacency list: `technical/docs/architecture/library-system-intelligence-map.dependencies.adjlist`
