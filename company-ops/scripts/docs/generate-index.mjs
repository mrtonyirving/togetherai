#!/usr/bin/env node

import fs from 'node:fs';
import path from 'node:path';

const ROOT = process.cwd();
const DOCS_DIR = path.join(ROOT, 'docs');
const OUTPUT = path.join(DOCS_DIR, '_index.generated.md');

function listMarkdownFiles(dir, depth = 0) {
  const lines = [];
  const entries = fs
    .readdirSync(dir, { withFileTypes: true })
    .filter((e) => !e.name.startsWith('.'))
    .sort((a, b) => a.name.localeCompare(b.name));

  for (const entry of entries) {
    const abs = path.join(dir, entry.name);
    const rel = path.relative(DOCS_DIR, abs).replace(/\\/g, '/');

    if (entry.isDirectory()) {
      lines.push(`${'  '.repeat(depth)}- **${entry.name}/**`);
      lines.push(...listMarkdownFiles(abs, depth + 1));
      continue;
    }

    if (entry.isFile() && entry.name.endsWith('.md')) {
      lines.push(`${'  '.repeat(depth)}- [${entry.name}](./${rel})`);
    }
  }

  return lines;
}

if (!fs.existsSync(DOCS_DIR)) {
  console.error('docs directory not found');
  process.exit(1);
}

const today = new Date().toISOString().slice(0, 10);
const body = [
  '# Generated Docs Index',
  '',
  'Auto-generated by `scripts/docs/generate-index.mjs`.',
  '',
  `Last generated: ${today}`,
  '',
  ...listMarkdownFiles(DOCS_DIR),
  '',
].join('\n');

fs.writeFileSync(OUTPUT, body);
console.log(`Wrote ${path.relative(ROOT, OUTPUT)}`);
